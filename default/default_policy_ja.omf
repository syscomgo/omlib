[{"app_name":" SSHコマンド","app_attr":"sch","flow_list":[{"flow_name":" SSHコマンド","description":"","attr":"sch","flowobject":{"flow_item_counter":3,"flow_line_counter":2,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":" 始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":true,"value":null,"name":"ssh_ip","des":""},{"require":true,"value":null,"name":"ssh_port","des":""},{"require":true,"value":null,"name":"username","des":""},{"require":true,"value":null,"name":"password","des":""},{"require":false,"value":null,"name":"root_pwd","des":""},{"require":true,"value":null,"name":"cmdlist","des":""}],"output":[],"subflow_input":[],"subflow_output":[],"top":0,"left":210,"callable":false,"subflow_id":"","verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":" 終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(resplist)","name":"$(resplist)","des":""}],"calculate":[],"top":250,"left":210}},{"id":"FITEM_3","type":"python","text":" 埋め込む","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":true,"input":[{"require":false,"value":"$(ssh_ip)","name":"ssh_ip","des":""},{"require":false,"value":"$(ssh_port)","name":"ssh_port","des":""},{"require":false,"value":"$(username)","name":"username","des":""},{"require":false,"value":"$(password)","name":"password","des":""},{"require":false,"value":"$(root_pwd)","name":"root_pwd","des":""},{"require":false,"value":"$(cmdlist)","name":"cmdlist","des":""},{"require":false,"value":null,"name":"resplist","des":""}],"output":[{"value":"$(resplist)","name":"$(resplist)","des":""}],"calculate":[],"code":"import paramiko,time,re\ndef connect_ssh(ssh_ip,port,username,password):\n    ssh = paramiko.SSHClient()\n    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())\n    ssh.connect(\n         hostname = ssh_ip,\n         port = port,\n         username = username,\n         password = password,\n         timeout = 60,\n       )\n    return ssh\n\ndef exec_root_password(command,sc):\n    sc.send(command + '\\n')\n    time.sleep(2)\n    result = sc.recv(1024).decode('utf-8')\n    return result\n\ndef exe_cmd(command,sc):\n    sc.send(command + '\\n')\n    results = ''\n    from datetime import datetime,timedelta\n    timeout = datetime.now() + timedelta(seconds=20)\n    final_result = {}\n    while True: \n        time.sleep(1)\n        result = sc.recv(1024).decode('utf-8')\n        results += result\n        #如果結尾有這幾個符號，代表已經做完了\n        if results[-2:] in ['$ ', '> ', '* ','# ',\": \"] :\n            final_result[\"status\"] = \"Success\"\n            final_result[\"result\"] = results\n            break\n        #如果會需要輸入 yes or no,會直接Crtl+C,timeout時間預設20秒，會直接Crtl+C\n        elif results[-2:] in \"? \" or datetime.now() > timeout :\n            sc.send(\"\\x03\" + '\\n')\n            final_result[\"status\"] = \"Success\"\n            final_result[\"result\"] = results\n            break\n    return final_result\n\n# def exe_cmd(command,sc):\n#     sc.send(command)\n#     sc.send('\\n')\n#     time.sleep(2)\n#     result = sc.recv(9999).decode('utf-8')\n#     return result\n\nansi_escape = re.compile(r'\\x1B\\[[0-?]*[ -/]*[@-~]')\nresplist = []\ncombine_list = []\n#cmdlist = \"whoami,cd /opt/omflow,ll\"\ncmdlist = cmdlist.split(',')\ncon_obj = connect_ssh(ssh_ip,ssh_port,username,password)\nsc = con_obj.invoke_shell()\nroot_pwd = root_pwd\nif root_pwd == \"\":\n    for i in cmdlist:\n        resp = exe_cmd(i,sc)\n        if resp[\"status\"] == \"Success\":\n            respsub = resp[\"result\"].split(\"\\r\\n\")\n            respsublist = [x.lstrip(\"\\r\\n\") for x in respsub]\n            resplist.extend(respsub)\n    resplist.pop(-1)\n    count = 0\n    first_count = -1\n    for sub_i in resplist:\n        count += 1\n        i = ansi_escape.sub('', sub_i)\n        if len(i) >=2:\n            if \"# \" == i[-2:] or \"$ \" == i[-2:]:\n                cmd_str = resplist[count]\n                com_line = i  + cmd_str\n                combine_list.append(com_line)\n            elif cmdlist[first_count] == i :\n                first_count+=1\n            else:\n                if i in cmdlist :\n                    pass\n                else:\n                    combine_list.append(i)\nelse:\n    resp = exec_root_password(\"sudo -s\",sc)\n    respsub = resp.split(\"\\r\\n\")\n    resplist.extend(respsub)\n    if resp.endswith(u\"[sudo] password for administrator: \"):\n        resp = exe_cmd(root_pwd,sc)\n        if resp[\"status\"] == \"Success\":\n            respsub = resp[\"result\"].split(\"\\r\\n\")\n            resplist.extend(respsub)\n        for i in cmdlist:\n            resp = exe_cmd(i,sc)\n            if resp[\"status\"] == \"Success\":\n                respsub = resp[\"result\"].split(\"\\r\\n\")\n                respsublist = [x.strip(\"\\r\\n\") for x in respsub]\n                resplist.extend(respsublist)\n        resplist.pop(-1)\n        count = 0\n        first_count = -1\n        for sub_i in resplist:\n            count += 1\n            i = ansi_escape.sub('', sub_i)\n            if \"# \" == i[-2:] or \"$ \" == i[-2:]:\n                cmd_str = resplist[count]\n                com_line = i  + cmd_str\n                combine_list.append(com_line)\n            elif  cmdlist[first_count] == i :\n                first_count+=1\n            else:\n                if i in cmdlist or i == \"sudo -s\":\n                    pass\n                else:\n                    combine_list.append(i)\n    \nfinal_str = \"\"\nfor thisStr in combine_list:\n    final_str = final_str  + thisStr + '\\n'\n    \nresplist = final_str\ncon_obj.close()","top":125,"left":210,"collector":null,"packages":[]}},{"id":"FLINE_MW1","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_3","source_item":"FITEM_1","idcounter":4,"linebox_left":270,"linebox_top":112.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":135,"linebox_arrow_left":266}},{"id":"FLINE_MW2","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_3","idcounter":5,"linebox_left":270,"linebox_top":237.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":260,"linebox_arrow_left":266}}],"version":16777216,"uid":1600671257109,"wnd_height":500},"config":{"subflow":[],"name":" SSHコマンド","description":"","type":"text","api_path":"ssh-command-monitor","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"text","event_rule":"{}","os_type":""}]},{"app_name":" 基本的な監視","app_attr":"sch","flow_list":[{"flow_name":" 基本的な監視","description":"","attr":"sch","flowobject":{"flow_item_counter":3,"flow_line_counter":2,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":" 始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"callable":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":false,"value":null,"name":"cpu","des":""},{"require":false,"value":null,"name":"ram","des":""},{"require":false,"value":null,"name":"disk","des":""}],"output":[],"subflow_input":[],"subflow_output":[],"top":0,"left":210,"subflow_id":"","verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":" 終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(cpu)","name":"$(cpu)","des":"CPU使用率(%)"},{"value":"$(ram)","name":"$(ram)","des":"RAM使用率(%)"},{"value":"$(disk)","name":"$(disk)","des":"DISK使用率(%)"}],"calculate":[],"top":250,"left":210}},{"id":"FITEM_3","type":"python","text":"埋め込む","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":false,"input":[{"require":false,"value":"$(cpu)","name":"cpu","des":""},{"require":false,"value":"$(ram)","name":"ram","des":""},{"require":false,"value":"$(disk)","name":"disk","des":""}],"output":[{"value":"$(cpu)","name":"$(cpu)","des":""},{"value":"$(ram)","name":"$(ram)","des":""},{"value":"$(disk)","name":"$(disk)","des":""}],"calculate":[],"code":"import psutil\n\ncpu = psutil.cpu_percent()\nram = psutil.virtual_memory().percent\ndisk = psutil.disk_usage('/').percent","top":125,"left":210,"packages":[],"collector":null}},{"id":"FLINE_MW1","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_3","source_item":"FITEM_1","idcounter":4,"linebox_left":270,"linebox_top":112.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":135,"linebox_arrow_left":266}},{"id":"FLINE_MW2","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_3","idcounter":5,"linebox_left":270,"linebox_top":237.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":260,"linebox_arrow_left":266}}],"version":16777216,"uid":1592295834531,"wnd_height":500},"config":{"subflow":[],"name":" 基本的な監視","description":"","type":"num","api_path":"base-monitor","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"num","event_rule":"{}","os_type":""}]},{"app_name":"データベース監視-MySQL","app_attr":"sch","flow_list":[{"flow_name":"データベース監視-MySQL","description":"","attr":"sch","flowobject":{"flow_item_counter":10,"flow_line_counter":17,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":"始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":false,"value":null,"name":"domain","des":"IP位置"},{"require":false,"value":null,"name":"port","des":"資料庫連接埠"},{"require":false,"value":null,"name":"db_name","des":"資料庫名稱"},{"require":false,"value":null,"name":"user","des":"使用者帳號"},{"require":false,"value":null,"name":"password","des":"使用者密碼"}],"output":[],"subflow_input":[],"subflow_output":[],"top":25,"left":390,"verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":" 終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(connection_status)","name":"$(connection_status)","des":"資料庫連線狀態"},{"value":"$(max_connection_count)","name":"$(max_connection_count)","des":"最大連線數"},{"value":"$(connections_count)","name":"$(connections_count)","des":"連線數"},{"value":"$(database_space)","name":"$(database_space)","des":"資料庫空間使用狀況(Mb)"},{"value":"$(response_time)","name":"$(response_time)","des":"查詢回應時間(秒)"},{"value":"$(buffer_cache_hit_ratio)","name":"$(buffer_cache_hit_ratio)","des":"查詢緩衝命中率(%)"}],"calculate":[],"top":268,"left":390}},{"id":"FITEM_3","type":"python","text":"データベースコマンドを実行する","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":true,"input":[{"require":false,"value":"$(domain)","name":"domain","des":""},{"require":false,"value":"$(db_name)","name":"db_name","des":""},{"require":false,"value":"$(port)","name":"port","des":""},{"require":false,"value":"$(user)","name":"user","des":""},{"require":false,"value":"$(password)","name":"password","des":""},{"require":false,"value":"$(syspm_domain)","name":"syspm_domain","des":""},{"require":false,"value":"$(syspm_db_name)","name":"syspm_db_name","des":""},{"require":false,"value":"$(syspm_port)","name":"syspm_port","des":""},{"require":false,"value":"$(syspm_user)","name":"syspm_user","des":""},{"require":false,"value":"$(syspm_password)","name":"syspm_password","des":""},{"require":false,"value":null,"name":"connection_status","des":""},{"require":false,"value":null,"name":"max_connection_count","des":""},{"require":false,"value":null,"name":"connections_count","des":""},{"require":false,"value":null,"name":"database_space","des":""},{"require":false,"value":null,"name":"response_time","des":""},{"require":false,"value":null,"name":"buffer_cache_hit_ratio","des":""}],"output":[{"value":"$(connection_status)","name":"$(connection_status)","des":""},{"value":"$(max_connection_count)","name":"$(max_connection_count)","des":""},{"value":"$(connections_count)","name":"$(connections_count)","des":""},{"value":"$(database_space)","name":"$(database_space)","des":""},{"value":"$(response_time)","name":"$(response_time)","des":""},{"value":"$(buffer_cache_hit_ratio)","name":"$(buffer_cache_hit_ratio)","des":""}],"calculate":[{"type":"sys_parameter","from":"$(schedule_name)","para1":"domain","para2":"$(schedule_name)","to":"$(syspm_domain)"},{"type":"sys_parameter","from":null,"para1":"port","para2":null,"to":"$(syspm_port)"},{"type":"sys_parameter","from":null,"para1":"db_name","para2":null,"to":"$(sys_pm_db_name)"},{"type":"sys_parameter","from":null,"para1":"user","para2":null,"to":"$(syspm_user)"},{"type":"sys_parameter","from":null,"para1":"password","para2":null,"to":"$(syspm_password)"}],"code":"import mysql.connector \nfrom datetime import datetime\nconn = None\ncursor = None\n\nif not domain:\n    domain = syspm_domain\nif not db_name:\n    db_name = syspm_db_name\nif not port:\n    port = syspm_port\nif not user:\n    user = syspm_user\nif not password:\n    password = syspm_password\n\n\ndef checkConnectionStatus(cursor):\n    cursor.execute(\"select 1 as status\")\n    data = cursor.fetchone()\n    return data\n\ndef getMaxConnections(cursor):\n    cursor.execute(\"show variables like 'max_connections';\")\n    data = cursor.fetchone()\n    return data\n\ndef getDataBaseSpace(cursor):\n    cursor.execute(\"select sum((data_length+index_length)/1024/1024) AS MB from information_schema.tables;\")\n    data = cursor.fetchone()\n    return data\n\ndef getConnections(cursor):\n    cursor.execute(\"SHOW STATUS WHERE variable_name = 'Threads_connected';\")\n    data = cursor.fetchone()\n    return data\n\ndef checkResponseTime(cursor):\n    ex_time = datetime.now()\n    cursor.execute(\"select 1 as status\")\n    now_time = datetime.now()\n    response_time = now_time - ex_time\n    result = response_time.total_seconds()\n    return result\n\ndef checkCacheHitRatio(cursor):\n    cursor.execute(\"show status like 'qcache_hits';\")\n    data = cursor.fetchone()\n    return data\n\n\nconnection_status = None\nmax_connection_count = None\nconnections_count = None\ndatabase_space = None\nresponse_time = None\nbuffer_cache_hit_ratio = None\n    \n    \nif __name__:\n    try:\n        conn = mysql.connector.connect(host=domain,user=user,port =port,password=password,database=db_name,auth_plugin='mysql_native_password')\n        cursor = conn.cursor(buffered=True)\n        connection_status = checkConnectionStatus(cursor)[0]\n        max_connection_count = getMaxConnections(cursor)[1]\n        connections_count = getConnections(cursor)[1]\n        database_space = getDataBaseSpace(cursor)[0]\n        response_time = checkResponseTime(cursor)\n        buffer_cache_hit_ratio = checkCacheHitRatio(cursor)[1]\n    except:\n        pass\n    finally:\n        cursor.close()\n        conn.close()","top":150,"left":390,"collector":null,"packages":[]}},{"id":"FLINE_MW2","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_3","idcounter":5,"linebox_left":450,"linebox_top":259,"linebox_long":0,"linebox_top_width":29,"linebox_bottom_width":-29,"linebox_arrow_top":278,"linebox_arrow_left":446}},{"id":"FLINE_MW17","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_3","source_item":"FITEM_1","idcounter":17,"linebox_left":450,"linebox_top":137.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":160,"linebox_arrow_left":446}}],"version":16777216,"uid":1600236083329,"wnd_height":500},"config":{"subflow":[],"name":"データベース監視-MySQL","description":"","type":"num","api_path":"database-monitor-mysql","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"num","event_rule":"{}","os_type":""}]},{"app_name":" データベース監視-MSSQL","app_attr":"sch","flow_list":[{"flow_name":" データベース監視-MSSQL","description":"","attr":"sch","flowobject":{"flow_item_counter":10,"flow_line_counter":17,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":" 始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":false,"value":null,"name":"domain","des":"IP位置"},{"require":false,"value":null,"name":"port","des":"資料庫連接埠"},{"require":false,"value":null,"name":"db_name","des":"資料庫名稱"},{"require":false,"value":null,"name":"user","des":"使用者帳號"},{"require":false,"value":null,"name":"password","des":"使用者密碼"},{"require":false,"value":"SQL Server","name":"driver","des":"Driver"}],"output":[],"subflow_input":[],"subflow_output":[],"top":25,"left":390,"callable":false,"subflow_id":"","verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":"終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(connection_status)","name":"$(connection_status)","des":"資料庫連線狀態"},{"value":"$(blocked_processes)","name":"$(blocked_processes)","des":"阻塞執行緒"},{"value":"$(database_space)","name":"$(database_space)","des":"空間使用狀況(Mb)"},{"value":"$(connections_count)","name":"$(connections_count)","des":"連接數查詢"},{"value":"$(dead_lock_counts)","name":"$(dead_lock_counts)","des":"Deadlocks 數量"},{"value":"$(lock_requests)","name":"$(lock_requests)","des":"Lock Requests"},{"value":"$(cache_hit_ratio)","name":"$(cache_hit_ratio)","des":"程序快取的命中率(%)"},{"value":"$(packet_error_count)","name":"$(packet_error_count)","des":"封包錯誤數"},{"value":"$(cpu_useage)","name":"$(cpu_useage)","des":"CPU使用率(%)"},{"value":"$(response_time)","name":"$(response_time)","des":"回應時間(秒)"},{"value":"$(io_errors)","name":"$(io_errors)","des":"磁碟 IO錯誤"},{"value":"$(buffer_cache_hit_ratio)","name":"$(buffer_cache_hit_ratio)","des":"緩衝快取的命中率(%)"}],"calculate":[],"top":275,"left":390}},{"id":"FITEM_6","type":"python","text":"データベースコマンドを実行する","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":true,"input":[{"require":false,"value":"$(domain)","name":"domain","des":""},{"require":false,"value":"$(port)","name":"port","des":""},{"require":false,"value":"$(db_name)","name":"db_name","des":""},{"require":false,"value":"$(user)","name":"user","des":""},{"require":false,"value":"$(password)","name":"password","des":""},{"require":false,"value":"$(driver)","name":"driver","des":""},{"require":false,"value":"$(syspm_domain)","name":"syspm_domain","des":""},{"require":false,"value":"$(syspm_db_name)","name":"syspm_db_name","des":""},{"require":false,"value":"$(syspm_port)","name":"syspm_port","des":""},{"require":false,"value":"$(syspm_user)","name":"syspm_user","des":""},{"require":false,"value":"$(syspm_password)","name":"syspm_password","des":""},{"require":false,"value":null,"name":"connection_status","des":""},{"require":false,"value":null,"name":"blocked_processes","des":""},{"require":false,"value":null,"name":"database_space","des":""},{"require":false,"value":null,"name":"connections_count","des":""},{"require":false,"value":null,"name":"dead_lock_counts","des":""},{"require":false,"value":null,"name":"lock_requests","des":""},{"require":false,"value":null,"name":"cache_hit_ratio","des":""},{"require":false,"value":null,"name":"packet_error_count","des":""},{"require":false,"value":null,"name":"cpu_useage","des":""},{"require":false,"value":null,"name":"response_time","des":""},{"require":false,"value":null,"name":"io_errors","des":""},{"require":false,"value":null,"name":"buffer_cache_hit_ratio","des":""}],"output":[{"value":"$(connection_status)","name":"$(connection_status)","des":""},{"value":"$(blocked_processes)","name":"$(blocked_processes)","des":""},{"value":"$(database_space)","name":"$(database_space)","des":""},{"value":"$(connections_count)","name":"$(connections_count)","des":""},{"value":"$(dead_lock_counts)","name":"$(dead_lock_counts)","des":""},{"value":"$(lock_requests)","name":"$(lock_requests)","des":""},{"value":"$(cache_hit_ratio)","name":"$(cache_hit_ratio)","des":""},{"value":"$(packet_error_count)","name":"$(packet_error_count)","des":""},{"value":"$(cpu_useage)","name":"$(cpu_useage)","des":""},{"value":"$(response_time)","name":"$(response_time)","des":""},{"value":"$(io_errors)","name":"$(io_errors)","des":""},{"value":"$(buffer_cache_hit_ratio)","name":"$(buffer_cache_hit_ratio)","des":""}],"calculate":[{"type":"sys_parameter","from":null,"para1":"domain","para2":null,"to":"$(syspm_domain)"},{"type":"sys_parameter","from":null,"para1":"port","para2":null,"to":"$(syspm_port)"},{"type":"sys_parameter","from":"$(schedule_name)","para1":"db_name","para2":"$(schedule_name)","to":"$(syspm_db_name)"},{"type":"sys_parameter","from":null,"para1":"user","para2":null,"to":"$(syspm_user)"},{"type":"sys_parameter","from":null,"para1":"password","para2":null,"to":"$(syspm_password)"}],"code":"import pyodbc\nfrom datetime import datetime\nconn = None\ncursor = None\n\nif not domain:\n    domain = syspm_domain\nif not db_name:\n    db_name = syspm_db_name\nif not port:\n    port = syspm_port\nif not user:\n    user = syspm_user\nif not password:\n    password = syspm_password\n\n\ndef database_query(cursor, query):\n    try:\n        cursor.execute(query)\n        data = cursor.fetchone()\n    except:\n        data = None\n    finally:\n        return data\n\n\ndef getResponseTime(cursor, query):\n    try:\n        ex_time = datetime.now()\n        cursor.execute(query)\n        now_time = datetime.now()\n        response_time = now_time - ex_time\n        result = response_time.total_seconds()\n    except:\n        result = -1\n    finally:\n        return result\n    \n\nconnection_status = \"SELECT 1 as status\"\nblocked_processes = \"select count(1) as blockedProcesses from master..sysprocesses where blocked != 0;\"\ndatabase_space = \"select CAST(((SUM(Size)* 8) / 1024.0) AS DECIMAL(18,2) ) as mb from sys.master_files\"\nconnections_count = \"select (@@max_connections - (select COUNT(*) from master.dbo.sysprocesses)) as avaConnection, @@max_connections as maxConnection , (select COUNT(*) from master.dbo.sysprocesses )as UseConnection\"\ndead_lock_counts = \"select cntr_value from sys.dm_os_performance_counters where counter_name='Number of Deadlocks/sec' and instance_name='_Total';\"\nlock_requests = \"select cntr_value from sys.dm_os_performance_counters where counter_name='Lock Requests/sec' and instance_name='_Total';\"\ncache_hit_ratio = \"select cntr_value from sys.dm_os_performance_counters where counter_name='Cache Hit Ratio' and instance_name='_Total' and  object_name like'%Plan%';\"\npacket_error_count = \"select @@PACKET_ERRORS as PacketError;\"\ncpu_useage = \"WITH DB_CPU_Stats AS (SELECT DatabaseID, DB_Name(DatabaseID) AS [DatabaseName], SUM(total_worker_time) AS [CPU_Time_Ms] FROM sys.dm_exec_query_stats AS qs CROSS APPLY (SELECT CONVERT(int, value) AS [DatabaseID] FROM sys.dm_exec_plan_attributes(qs.plan_handle) WHERE attribute = N'dbid') AS F_DB GROUP BY DatabaseID) SELECT ROW_NUMBER() OVER(ORDER BY [CPU_Time_Ms] DESC) AS [row_num],DatabaseName,[CPU_Time_Ms], CAST([CPU_Time_Ms] * 1.0 / SUM([CPU_Time_Ms]) OVER() * 100.0 AS DECIMAL(5, 2)) AS [CPUPercent] FROM DB_CPU_Stats where DatabaseName = DB_NAME() ORDER BY row_num OPTION (RECOMPILE);\"\nresponse_time = \"select 1\"\nio_errors = \"select @@total_errors AS error\"\nbuffer_cache_hit_ratio = \"SELECT (a.cntr_value * 1.0 / b.cntr_value) * 100.0 as BufferCacheHitRatio FROM sys.dm_os_performance_counters  a JOIN  (SELECT cntr_value, OBJECT_NAME FROM sys.dm_os_performance_counters WHERE counter_name = 'Buffer cache hit ratio base' AND OBJECT_NAME = 'SQLServer:Buffer Manager') b ON  a.OBJECT_NAME = b.OBJECT_NAME WHERE a.counter_name = 'Buffer cache hit ratio' AND a.OBJECT_NAME = 'SQLServer:Buffer Manager'\"\n\nif __name__:\n    try:\n        conn = pyodbc.connect(driver='{'+driver+'}', host=domain, port=port, database=db_name, user=user, password=password)\n        cursor = conn.cursor()\n        connection_status = database_query(cursor, connection_status)[0]\n        blocked_processes = database_query(cursor, blocked_processes)[0]\n        database_space = database_query(cursor, database_space)[0]\n        connections_count = database_query(cursor, connections_count)[2]\n        dead_lock_counts = database_query(cursor, dead_lock_counts)[0]\n        lock_requests = database_query(cursor, lock_requests)[0]\n        cache_hit_ratio = database_query(cursor, cache_hit_ratio)[0]\n        packet_error_count = database_query(cursor, packet_error_count)[0]\n        cpu_useage = database_query(cursor, cpu_useage)[3]\n        response_time = getResponseTime(cursor, response_time)\n        io_errors = database_query(cursor, io_errors)[0]\n        buffer_cache_hit_ratio = database_query(cursor, buffer_cache_hit_ratio)[0]\n    except:\n        pass\n    finally:\n        cursor.close()\n        conn.close()","top":150,"left":390,"collector":null,"packages":[]}},{"id":"FLINE_MW10","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_6","idcounter":10,"linebox_left":450,"linebox_top":262.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":285,"linebox_arrow_left":446}},{"id":"FLINE_MW17","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_6","source_item":"FITEM_1","idcounter":17,"linebox_left":450,"linebox_top":137.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":160,"linebox_arrow_left":446}}],"version":16777216,"uid":1600236083329,"wnd_height":500},"config":{"subflow":[],"name":" データベース監視-MSSQL","description":"","type":"num","api_path":"database-monitor-mssql","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"num","event_rule":"{}","os_type":""}]},{"app_name":" データベース監視-PostgreSQL","app_attr":"sch","flow_list":[{"flow_name":" データベース監視-PostgreSQL","description":"","attr":"sch","flowobject":{"flow_item_counter":10,"flow_line_counter":17,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":" 始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":false,"value":null,"name":"domain","des":"IP位置"},{"require":false,"value":null,"name":"port","des":"資料庫連接埠"},{"require":false,"value":null,"name":"db_name","des":"資料庫名稱"},{"require":false,"value":null,"name":"user","des":"使用者帳號"},{"require":false,"value":null,"name":"password","des":"使用者密碼"}],"output":[],"subflow_input":[],"subflow_output":[],"top":25,"left":390,"callable":false,"subflow_id":"","verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":"終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(connection_status)","name":"$(connection_status)","des":"資料庫連線狀態"},{"value":"$(connections_count)","name":"$(connections_count)","des":"連接數查詢"},{"value":"$(index_ratio)","name":"$(index_ratio)","des":"索引緩存命中率(%)"},{"value":"$(cache_hit_ratio)","name":"$(cache_hit_ratio)","des":"緩存命中率(%)"},{"value":"$(response_time)","name":"$(response_time)","des":"回應時間(秒)"}],"calculate":[],"top":268,"left":390}},{"id":"FITEM_6","type":"python","text":" データベースコマンドを実行する","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":true,"input":[{"require":false,"value":"$(domain)","name":"domain","des":""},{"require":false,"value":"$(port)","name":"port","des":""},{"require":false,"value":"$(db_name)","name":"db_name","des":""},{"require":false,"value":"$(user)","name":"user","des":""},{"require":false,"value":"$(password)","name":"password","des":""},{"require":false,"value":"$(driver)","name":"driver","des":""},{"require":false,"value":"$(syspm_domain)","name":"syspm_domain","des":""},{"require":false,"value":"$(syspm_db_name)","name":"syspm_db_name","des":""},{"require":false,"value":"$(syspm_port)","name":"syspm_port","des":""},{"require":false,"value":"$(syspm_user)","name":"syspm_user","des":""},{"require":false,"value":"$(syspm_password)","name":"syspm_password","des":""},{"require":false,"value":"$(schedule_name)","name":"connection_status","des":""},{"require":false,"value":null,"name":"connections_count","des":""},{"require":false,"value":null,"name":"index_ratio","des":""},{"require":false,"value":null,"name":"cache_hit_ratio","des":""},{"require":false,"value":null,"name":"response_time","des":""}],"output":[{"value":"$(connection_status)","name":"$(connection_status)","des":""},{"value":"$(connections_count)","name":"$(connections_count)","des":""},{"value":"$(index_ratio)","name":"$(index_ratio)","des":""},{"value":"$(cache_hit_ratio)","name":"$(cache_hit_ratio)","des":""},{"value":"$(response_time)","name":"$(response_time)","des":""}],"calculate":[{"type":"sys_parameter","from":null,"para1":"domain","para2":null,"to":"$(syspm_domain)"},{"type":"sys_parameter","from":null,"para1":"port","para2":null,"to":"$(syspm_port)"},{"type":"sys_parameter","from":"$(schedule_name)","para1":"db_name","para2":"$(schedule_name)","to":"$(syspm_db_name)"},{"type":"sys_parameter","from":null,"para1":"user","para2":null,"to":"$(syspm_user)"},{"type":"sys_parameter","from":null,"para1":"password","para2":null,"to":"$(syspm_password)"}],"code":"import psycopg2\nfrom datetime import datetime\nconn = None\ncursor = None\n\nif not domain:\n    domain = syspm_domain\nif not db_name:\n    db_name = syspm_db_name\nif not port:\n    port = syspm_port\nif not user:\n    user = syspm_user\nif not password:\n    password = syspm_password\n\n\ndef database_query(cursor, query):\n    try:\n        cursor.execute(query)\n        data = cursor.fetchone()\n    except:\n        data = None\n    finally:\n        return data\n\n\ndef getResponseTime(cursor, query):\n    try:\n        ex_time = datetime.now()\n        cursor.execute(query)\n        now_time = datetime.now()\n        response_time = now_time - ex_time\n        result = response_time.total_seconds()\n    except:\n        result = 0\n    finally:\n        return result\n    \n\nconnection_status = \"select 1\"\nconnections_count = \"show max_connections;SELECT count(*) as now_connections FROM pg_stat_activity\"\nindex_ratio = \"SELECT sum(idx_blks_read) as idx_read, sum(idx_blks_hit)  as idx_hit, (sum(idx_blks_hit) - sum(idx_blks_read)) / sum(idx_blks_hit) as ratio FROM pg_statio_user_indexes;\"\ncache_hit_ratio = \"SELECT sum(heap_blks_read) as heap_read, sum(heap_blks_hit)  as heap_hit, sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) as ratio FROM pg_statio_user_tables;\"\nresponse_time = \"select count(*) from pg_catalog.pg_user\"\n\nif __name__:\n    try:\n        conn = psycopg2.connect(host=domain, port=port, database=db_name, user=user, password=password)\n        cursor = conn.cursor()\n        connection_status = database_query(cursor, connection_status)[0]\n        connections_count = database_query(cursor, connections_count)[0]\n        index_ratio = database_query(cursor, index_ratio)[2]\n        cache_hit_ratio = database_query(cursor, cache_hit_ratio)[2]\n        response_time = getResponseTime(cursor, response_time)\n    except:\n        pass\n    finally:\n        cursor.close()\n        conn.close()","top":150,"left":390,"collector":null,"packages":[]}},{"id":"FLINE_MW10","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_6","idcounter":10,"linebox_left":450,"linebox_top":259,"linebox_long":0,"linebox_top_width":29,"linebox_bottom_width":-29,"linebox_arrow_top":278,"linebox_arrow_left":446}},{"id":"FLINE_MW17","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_6","source_item":"FITEM_1","idcounter":17,"linebox_left":450,"linebox_top":137.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":160,"linebox_arrow_left":446}}],"version":16777216,"uid":1600236083329,"wnd_height":500},"config":{"subflow":[],"name":" データベース監視-PostgreSQL","description":"","type":"num","api_path":"database-monitor-postgre","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"num","event_rule":"{}","os_type":""}]},{"app_name":" データベース監視-Oracle","app_attr":"sch","flow_list":[{"flow_name":" データベース監視-Oracle","description":"","attr":"sch","flowobject":{"flow_item_counter":10,"flow_line_counter":17,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":" 始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":false,"value":null,"name":"domain","des":"IP位置"},{"require":false,"value":null,"name":"port","des":"資料庫連接埠"},{"require":false,"value":null,"name":"db_name","des":"資料庫名稱"},{"require":false,"value":null,"name":"user","des":"使用者帳號"},{"require":false,"value":null,"name":"password","des":"使用者密碼"}],"output":[],"subflow_input":[],"subflow_output":[],"top":25,"left":390,"callable":false,"subflow_id":"","verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":"終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(broken_jobs)","name":"$(broken_jobs)","des":"Broken Jobs"},{"value":"$(failed_jobs)","name":"$(failed_jobs)","des":"Failed Jobs"},{"value":"$(lock_conflicts)","name":"$(lock_conflicts)","des":"Lock Conflicts"},{"value":"$(overdue_jobs)","name":"$(overdue_jobs)","des":"Overdue Jobs"},{"value":"$(connection_status)","name":"$(connection_status)","des":"資料庫連線狀態"},{"value":"$(database_space)","name":"$(database_space)","des":"空間使用狀況"},{"value":"$(connections_count)","name":"$(connections_count)","des":"連接數查詢"},{"value":"$(free_buffer_wait_ratio)","name":"$(free_buffer_wait_ratio)","des":"Free Buffer Wait Ratio"},{"value":"$(library_cache_hit_ratio)","name":"$(library_cache_hit_ratio)","des":"Library Cache Hit Ratio"},{"value":"$(mts)","name":"$(mts)","des":"MTS"},{"value":"$(redo_log_space_wait_time)","name":"$(redo_log_space_wait_time)","des":"Redo Log Space Wait Time"},{"value":"$(rollback_wraps)","name":"$(rollback_wraps)","des":"Rollback Wraps 數量"},{"value":"$(rollback_segment_wait_ratio)","name":"$(rollback_segment_wait_ratio)","des":"Rollback 段落的等待比"},{"value":"$(user_commits)","name":"$(user_commits)","des":"Transactions parameter"},{"value":"$(response_time)","name":"$(response_time)","des":"回應時間(秒)"},{"value":"$(buffer_cache_hit_ratio)","name":"$(buffer_cache_hit_ratio)","des":"緩衝快取的命中率(%)"},{"value":"$(log_buffer_used)","name":"$(log_buffer_used)","des":"緩衝日誌的使用情況"},{"value":"$(redo_log_wait_ratio)","name":"$(redo_log_wait_ratio)","des":"記憶體中的排序比"},{"value":"$(data_file_io_waits)","name":"$(data_file_io_waits)","des":"資料文件的IO等待次數"}],"calculate":[],"top":268,"left":390}},{"id":"FITEM_6","type":"python","text":" データベースコマンドを実行する","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":true,"input":[{"require":false,"value":"$(domain)","name":"domain","des":""},{"require":false,"value":"$(port)","name":"port","des":""},{"require":false,"value":"$(db_name)","name":"db_name","des":""},{"require":false,"value":"$(user)","name":"user","des":""},{"require":false,"value":"$(password)","name":"password","des":""},{"require":false,"value":"$(driver)","name":"driver","des":""},{"require":false,"value":"$(syspm_domain)","name":"syspm_domain","des":""},{"require":false,"value":"$(syspm_db_name)","name":"syspm_db_name","des":""},{"require":false,"value":"$(syspm_port)","name":"syspm_port","des":""},{"require":false,"value":"$(syspm_user)","name":"syspm_user","des":""},{"require":false,"value":"$(syspm_password)","name":"syspm_password","des":""},{"require":false,"value":null,"name":"broken_jobs","des":""},{"require":false,"value":null,"name":"failed_jobs","des":""},{"require":false,"value":null,"name":"lock_conflicts","des":""},{"require":false,"value":null,"name":"overdue_jobs","des":""},{"require":false,"value":null,"name":"connection_status","des":""},{"require":false,"value":null,"name":"database_space","des":""},{"require":false,"value":null,"name":"connections_count","des":""},{"require":false,"value":null,"name":"free_buffer_wait_ratio","des":""},{"require":false,"value":null,"name":"library_cache_hit_ratio","des":""},{"require":false,"value":null,"name":"mts","des":""},{"require":false,"value":null,"name":"redo_log_space_wait_time","des":""},{"require":false,"value":null,"name":"rollback_wraps","des":""},{"require":false,"value":null,"name":"rollback_segment_wait_ratio","des":""},{"require":false,"value":null,"name":"user_commits","des":""},{"require":false,"value":null,"name":"response_time","des":""},{"require":false,"value":null,"name":"buffer_cache_hit_ratio","des":""},{"require":false,"value":null,"name":"log_buffer_used","des":""},{"require":false,"value":null,"name":"redo_log_wait_ratio","des":""},{"require":false,"value":null,"name":"data_file_io_waits","des":""}],"output":[{"value":"$(broken_jobs)","name":"$(broken_jobs)","des":""},{"value":"$(failed_jobs)","name":"$(failed_jobs)","des":""},{"value":"$(lock_conflicts)","name":"$(lock_conflicts)","des":""},{"value":"$(overdue_jobs)","name":"$(overdue_jobs)","des":""},{"value":"$(connection_status)","name":"$(connection_status)","des":""},{"value":"$(database_space)","name":"$(database_space)","des":""},{"value":"$(connections_count)","name":"$(connections_count)","des":""},{"value":"$(free_buffer_wait_ratio)","name":"$(free_buffer_wait_ratio)","des":""},{"value":"$(library_cache_hit_ratio)","name":"$(library_cache_hit_ratio)","des":""},{"value":"$(mts)","name":"$(mts)","des":""},{"value":"$(redo_log_space_wait_time)","name":"$(redo_log_space_wait_time)","des":""},{"value":"$(rollback_wraps)","name":"$(rollback_wraps)","des":""},{"value":"$(rollback_segment_wait_ratio)","name":"$(rollback_segment_wait_ratio)","des":""},{"value":"$(user_commits)","name":"$(user_commits)","des":""},{"value":"$(response_time)","name":"$(response_time)","des":""},{"value":"$(buffer_cache_hit_ratio)","name":"$(buffer_cache_hit_ratio)","des":""},{"value":"$(log_buffer_used)","name":"$(log_buffer_used)","des":""},{"value":"$(redo_log_wait_ratio)","name":"$(redo_log_wait_ratio)","des":""},{"value":"$(data_file_io_waits)","name":"$(data_file_io_waits)","des":""}],"calculate":[{"type":"sys_parameter","from":null,"para1":"domain","para2":null,"to":"$(syspm_domain)"},{"type":"sys_parameter","from":null,"para1":"port","para2":null,"to":"$(syspm_port)"},{"type":"sys_parameter","from":"$(schedule_name)","para1":"db_name","para2":"$(schedule_name)","to":"$(syspm_db_name)"},{"type":"sys_parameter","from":null,"para1":"user","para2":null,"to":"$(syspm_user)"},{"type":"sys_parameter","from":null,"para1":"password","para2":null,"to":"$(syspm_password)"}],"code":"import cx_Oracle\nfrom datetime import datetime\nconn = None\ncursor = None\n\nif not domain:\n    domain = syspm_domain\nif not db_name:\n    db_name = syspm_db_name\nif not port:\n    port = syspm_port\nif not user:\n    user = syspm_user\nif not password:\n    password = syspm_password\n\n\ndef database_query(cursor, query):\n    try:\n        cursor.execute(query)\n        data = cursor.fetchone()\n    except:\n        data = None\n    finally:\n        return data\n\n\ndef getResponseTime(cursor, query):\n    try:\n        ex_time = datetime.now()\n        cursor.execute(query)\n        now_time = datetime.now()\n        response_time = now_time - ex_time\n        result = response_time.total_seconds()\n    except:\n        result = 0\n    finally:\n        return result\n    \n\nbroken_jobs = \"select count(1) from DBA_JOBS where BROKEN = 'Y'\"\nfailed_jobs = \"select count(1) as FailedJobs from DBA_JOBS where FAILURES > 0 and BROKEN != 'Y'\"\nlock_conflicts = \"select count(1) from v$lock where ctime > 120 and type in ('TM', 'TX', 'UL') and lmode = 0\"\noverdue_jobs = \"select count(1) from DBA_JOBS where NEXT_DATE < (SYSDATE - 2/1440) and INTERVAL != 'null'\"\nconnection_status = \"select 1 as status  from dual\"\ndatabase_space = \"select file_name, round(bytes/1048576,2), round(maxbytes/1048576,2), round((bytes - NVL(free_bytes,0))/1048576,2), autoextensible from dba_data_files a, dba_tablespaces b, (select file_id, sum(bytes) free_bytes from sys.dba_free_space group by file_id) c where contents = 'UNDO' and b.status = 'ONLINE' and a.tablespace_name = b.tablespace_name and b.tablespace_name = (select value from v$parameter where name='undo_tablespace') and bytes is not NULL and maxbytes is not NULL and c.file_id (+)= a.file_id order by 1\"\nconnections_count = \"select ((SELECT COUNT(*)FROM v$session)*-1)+(select value from v$parameter where name = 'processes') as Available,(SELECT COUNT(*)FROM v$session) AS Used,(select value from v$parameter where name = 'processes')as MaxConnections from dual\"\n\nfree_buffer_wait_ratio = \"select ((select VALUE from V$SYSSTAT where NAME in 'free buffer inspected') / (select VALUE from V$SYSSTAT where NAME in  'free buffer requested'))  as ratio from dual\"\nlibrary_cache_hit_ratio = \"select round(sum(pinhits)/sum(pins),4)*100 ||'%' 'Library Cache Hit Ratio' from v$librarycache order by namespace\"\nmts = \"select busy/(busy+idle) 'shared servers busy' from v$dispatcher\"\nredo_log_space_wait_time = \"select VALUE from V$SYSSTAT where NAME = 'redo log space wait time'\"\nrollback_wraps = \"select sum(WRAPS) from v$rollstat a, v$rollname b where a.USN=b.USN\"\nrollback_segment_wait_ratio = \"select sum(waits), sum(gets), round(sum(waits)/sum(gets),4) as ratio  from v$rollstat ' Wait Ratio = (waits / gets)'\"\nuser_commits = \"select NAME, VALUE from V$SYSSTAT where NAME = 'user commits'\"\nresponse_time = \"select 1 from dual\"\nbuffer_cache_hit_ratio = \"select round((1-(sum(decode(name,'physical reads',value,0))/(sum(decode(name,'db block gets',value,0)) + (sum(decode(name,'consistent gets',value,0))))))*100,2) 'Hit Ratio' from v$sysstat\"\nlog_buffer_used = \"select rbar.name,rbar.value,re.name,re.value,to_char((rbar.value*100)/re.value,90.99999)||'%' 'radio' from v$sysstat rbar,v$sysstat re where rbar.name='redo buffer allocation retries' and re.name='redo entries'\"\nredo_log_wait_ratio = \"select round((select VALUE from V$SYSSTAT where NAME in 'redo log space requests')/(select VALUE from V$SYSSTAT where NAME in 'redo entries'),6) as ratio from dual\"\ndata_file_io_waits = \"select sum(total_waits) from v$system_event where event in ('db file sequential read','db file scattered read','db file single write','db file parallel write')\"\n\n\nif __name__:\n    try:\n        connect_info =  user+\"/\"+password+\"@\"+domain+\":\"+port+\"/\"+db_name\n        conn = cx_Oracle.connect(connect_info)\n        cursor = conn.cursor()\n        broken_jobs = database_query(cursor, broken_jobs)[0]\n        failed_jobs = database_query(cursor, failed_jobs)[0]\n        lock_conflicts = database_query(cursor, lock_conflicts)[0]\n        overdue_jobs = database_query(cursor, overdue_jobs)[0]\n        connection_status = database_query(cursor, connection_status)[0]\n        database_space = database_query(cursor, database_space)[3]\n        connections_count = database_query(cursor, connections_count)[1]\n        \n        free_buffer_wait_ratio = database_query(cursor, free_buffer_wait_ratio)[0]\n        library_cache_hit_ratio = database_query(cursor, library_cache_hit_ratio)[0]\n        mts = database_query(cursor, mts)[0]\n        redo_log_space_wait_time = database_query(cursor, redo_log_space_wait_time)[0]\n        rollback_wraps = database_query(cursor, rollback_wraps)[0]\n        rollback_segment_wait_ratio = database_query(cursor, rollback_segment_wait_ratio)[2]\n        user_commits = database_query(cursor, user_commits)[1]\n        response_time = getResponseTime(cursor, response_time)\n        buffer_cache_hit_ratio = database_query(cursor, buffer_cache_hit_ratio)[0]\n        log_buffer_used = database_query(cursor, log_buffer_used)[4]\n        redo_log_wait_ratio = database_query(cursor, redo_log_wait_ratio)[0]\n        data_file_io_waits = database_query(cursor, data_file_io_waits)[0]\n    except:\n        pass\n    finally:\n        cursor.close()\n        conn.close()","top":150,"left":390,"collector":null,"packages":[]}},{"id":"FLINE_MW10","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_6","idcounter":10,"linebox_left":450,"linebox_top":259,"linebox_long":0,"linebox_top_width":29,"linebox_bottom_width":-29,"linebox_arrow_top":278,"linebox_arrow_left":446}},{"id":"FLINE_MW17","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_6","source_item":"FITEM_1","idcounter":17,"linebox_left":450,"linebox_top":137.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":160,"linebox_arrow_left":446}}],"version":16777216,"uid":1600236083329,"wnd_height":500},"config":{"subflow":[],"name":" データベース監視-Oracle","description":"","type":"num","api_path":"database-monitor-oracle","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"num","event_rule":"{}","os_type":""}]},{"app_name":" SNMPモニタリング","app_attr":"sch","flow_list":[{"flow_name":" SNMPモニタリング","description":"","attr":"sch","flowobject":{"flow_item_counter":3,"flow_line_counter":2,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":" 始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":false,"value":null,"name":"snmp_host","des":"代理程式位址"},{"require":false,"value":"161","name":"snmp_port","des":"代理程式埠號"},{"require":false,"value":"public","name":"snmp_community","des":"代理程式社群"},{"require":false,"value":null,"name":"snmp_OID","des":"代理程式OID"}],"output":[],"subflow_input":[],"subflow_output":[],"top":0,"left":210,"callable":false,"subflow_id":"","verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":" 終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(OID_vlaue)","name":"$(OID_vlaue)","des":"OID查詢結果"}],"calculate":[],"top":250,"left":210}},{"id":"FITEM_3","type":"python","text":" 埋め込む","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":true,"input":[{"require":false,"value":"$(snmp_host)","name":"host","des":""},{"require":false,"value":"$(snmp_port)","name":"port","des":""},{"require":false,"value":"$(snmp_community)","name":"community","des":""},{"require":false,"value":"$(snmp_OID)","name":"OID","des":""},{"require":false,"value":null,"name":"OID_value","des":""}],"output":[{"value":"$(OID_value)","name":"$(OID_vlaue)","des":""}],"calculate":[],"code":"import asyncio\nimport aiosnmp\n\nasync def main():\n    global OID_value\n    with aiosnmp.Snmp(host=host, port=int(port), community=community) as snmp:\n        for res in await snmp.get(OID):\n            OID_value = res.value\n\nloop = asyncio.new_event_loop()\nasyncio.set_event_loop(loop)\nloop.run_until_complete(main())","top":125,"left":210,"collector":null,"packages":[]}},{"id":"FLINE_MW1","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_3","source_item":"FITEM_1","idcounter":4,"linebox_left":270,"linebox_top":112.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":135,"linebox_arrow_left":266}},{"id":"FLINE_MW2","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_3","idcounter":5,"linebox_left":270,"linebox_top":237.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":260,"linebox_arrow_left":266}}],"version":16777216,"uid":1602818042243,"wnd_height":500},"config":{"subflow":[],"name":" SNMPモニタリング","description":"","type":"num","api_path":"snmp","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"num","event_rule":"{}","os_type":""}]},{"app_name":" Webページの検出","app_attr":"sch","flow_list":[{"flow_name":" Webページの検出","description":"","attr":"sch","flowobject":{"flow_item_counter":3,"flow_line_counter":2,"form_object":{"form_item_counter":0,"form_box_counter":0,"user":[],"group":[],"level":[],"title":false,"status":[],"op1":[],"op2":[],"items":[]},"is_sub":false,"subflow":[],"items":[{"id":"FITEM_1","type":"start","text":" 始める","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"input":[{"require":false,"value":null,"name":"schedule_name","des":"排程名稱"},{"require":false,"value":null,"name":"login_url","des":"登入URL"},{"require":false,"value":null,"name":"login_data","des":"登入參數，ex:{ \"username\":\"alan\",\"password\":\"334578\",...}"},{"require":false,"value":null,"name":"login_wait","des":""},{"require":false,"value":null,"name":"action_url","des":"動作URL"},{"require":false,"value":null,"name":"action_data","des":"動作參數，ex: {\"action\":\"new\",\"count\":3,....}"},{"require":false,"value":null,"name":"action_wait","des":""},{"require":false,"value":null,"name":"logout_url","des":"登出URL"},{"require":false,"value":null,"name":"logout_data","des":"登出參數，ex: {\"username\":\"alan\",\"password\":\"3345678\",...}"}],"output":[],"subflow_input":[],"subflow_output":[],"top":0,"left":210,"callable":false,"subflow_id":"","verify":false,"python_input":[{"require":false,"value":"success","name":"result","des":""},{"require":false,"value":null,"name":"message","des":""}],"python_output":[{"require":false,"value":"$(status)","name":"status","des":"輸出success則通過，其他則失敗"},{"require":false,"value":"$(message)","name":"message","des":""}],"python_code":"","packages":[]}},{"id":"FITEM_2","type":"end","text":" 終了","left":0,"top":0,"config":{"output":[{"value":"$(schedule_name)","name":"$(schedule_name)","des":"排程名稱"},{"value":"$(login_status)","name":"$(login_status)","des":""},{"value":"$(login_text)","name":"$(login_text)","des":""},{"value":"$(action_status)","name":"$(action_status)","des":""},{"value":"$(action_text)","name":"$(action_text)","des":""},{"value":"$(logout_status)","name":"$(logout_status)","des":""},{"value":"$(logout_text)","name":"$(logout_text)","des":""},{"value":"$(login_time)","name":"$(login_time)","des":""},{"value":"$(action_time)","name":"$(action_time)","des":""},{"value":"$(logout_time)","name":"$(logout_time)","des":""}],"calculate":[],"top":250,"left":210}},{"id":"FITEM_3","type":"python","text":" 埋め込む","left":0,"top":0,"config":{"error_pass":false,"load_balance":false,"log":true,"input":[{"require":false,"value":"$(login_url)","name":"login_url","des":""},{"require":false,"value":"$(login_data)","name":"login_data","des":""},{"require":false,"value":"$(login_wait)","name":"login_wait","des":""},{"require":false,"value":null,"name":"login_status","des":""},{"require":false,"value":null,"name":"login_text","des":""},{"require":false,"value":null,"name":"login_time","des":""},{"require":false,"value":"$(action_url)","name":"action_url","des":""},{"require":false,"value":"$(action_data)","name":"action_data","des":""},{"require":false,"value":"$(action_wait)","name":"action_wait","des":""},{"require":false,"value":null,"name":"action_status","des":""},{"require":false,"value":null,"name":"action_text","des":""},{"require":false,"value":null,"name":"action_time","des":""},{"require":false,"value":"$(logout_url)","name":"logout_url","des":""},{"require":false,"value":"$(logout_data)","name":"logout_data","des":""},{"require":false,"value":null,"name":"logout_status","des":""},{"require":false,"value":null,"name":"logout_text","des":""},{"require":false,"value":null,"name":"logout_time","des":""}],"output":[{"value":"$(login_status)","name":"$(login_status)","des":""},{"value":"$(login_text)","name":"$(login_text)","des":""},{"value":"$(action_status)","name":"$(action_status)","des":""},{"value":"$(action_text)","name":"$(action_text)","des":""},{"value":"$(logout_status)","name":"$(logout_status)","des":""},{"value":"$(logout_text)","name":"$(logout_text)","des":""},{"value":"$(login_time)","name":"$(login_time)","des":""},{"value":"$(action_time)","name":"$(action_time)","des":""},{"value":"$(logout_time)","name":"$(logout_time)","des":""}],"calculate":[],"code":"import requests, json, time\n\nheaders = {\n    \"User-Agent\": \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\"\n    }\n\nlogin_data = json.loads(login_data)\naction_data = json.loads(action_data)\nlogout_data = json.loads(logout_data)\n\nsession = requests.Session()\n#登入\nlogin_result = session.post(login_url, headers = headers, data = login_data, timeout = 5)\nlogin_status = login_result.status_code\nlogin_text = login_result.text\nlogin_time = login_result.elapsed.total_seconds()\ntime.sleep(int(login_wait))\n#執行\naction_result = session.get(action_url, headers = headers, data = action_data, timeout = 5)\naction_status = action_result.status_code\naction_text = action_result.text\naction_time = action_result.elapsed.total_seconds()\ntime.sleep(int(action_wait))\n#登出\nlogout_result = session.get(logout_url, headers = headers, data = logout_data, timeout = 5)\nlogout_status = logout_result.status_code\nlogout_text = logout_result.text\nlogout_time = logout_result.elapsed.total_seconds()\n\n\n\n\n","top":125,"left":210,"collector":null,"packages":[]}},{"id":"FLINE_MW1","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_3","source_item":"FITEM_1","idcounter":4,"linebox_left":270,"linebox_top":112.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":135,"linebox_arrow_left":266}},{"id":"FLINE_MW2","type":"line","config":{"target_side":"top","source_side":"bottom","target_item":"FITEM_2","source_item":"FITEM_3","idcounter":5,"linebox_left":270,"linebox_top":237.5,"linebox_long":0,"linebox_top_width":32.5,"linebox_bottom_width":-32.5,"linebox_arrow_top":260,"linebox_arrow_left":266}}],"version":16777216,"uid":1600247761116,"wnd_height":500},"config":{"subflow":[],"name":" Webページの検出","description":"","type":"text","api_path":"web-detect-monitor","fp_show":false,"attachment":false,"relation":false,"worklog":false,"history":false,"mission":false,"flowlog":false,"api":false},"type":"text","event_rule":"{}","os_type":null}]}]